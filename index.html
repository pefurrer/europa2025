<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Roteiro de Viagem</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <!-- Leaflet CSS para o Mapa -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --background-color: #f4f7f6;
            --card-background: #ffffff;
            --text-color: #333;
            --border-color: #e9ecef;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--background-color); color: var(--text-color); margin: 0; padding: 0; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        header { text-align: center; margin-bottom: 20px; }
        header h1 { color: var(--primary-color); margin-bottom: 5px; }

        /* Estilos das Abas */
        .tab-nav { display: flex; border-bottom: 2px solid var(--border-color); margin-bottom: 20px; }
        .tab-btn { padding: 10px 20px; cursor: pointer; background: none; border: none; font-size: 1.1em; color: var(--secondary-color); border-bottom: 3px solid transparent; }
        .tab-btn.active { color: var(--primary-color); border-bottom-color: var(--primary-color); font-weight: bold; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Estilos do Roteiro */
        #countdown { font-size: 1.1em; color: var(--secondary-color); background-color: var(--card-background); padding: 10px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px;}
        .filters-wrapper { overflow-x: auto; padding-bottom: 10px; margin-bottom: 25px; -webkit-overflow-scrolling: touch; }
        .filters { display: flex; flex-wrap: nowrap; gap: 10px; padding: 5px 0; }
        .filter-btn { background-color: var(--card-background); color: var(--primary-color); border: 1px solid var(--primary-color); padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 0.9em; transition: all 0.2s ease-in-out; white-space: nowrap; }
        .filter-btn:hover, .poi-filter-btn:hover { background-color: var(--primary-color); color: white; }
        .filter-btn.active, .poi-filter-btn.active { background-color: var(--primary-color); color: white; font-weight: bold; }
        .filter-btn.completed { text-decoration: line-through; opacity: 0.7; background-color: #e9ecef; border-color: #ced4da; color: var(--secondary-color); }
        .day-header { font-size: 1.5em; font-weight: 700; color: var(--primary-color); padding-bottom: 10px; border-bottom: 2px solid var(--border-color); margin-bottom: 15px; }
        .event-card { background-color: var(--card-background); border-left: 5px solid var(--secondary-color); border-radius: 8px; padding: 15px; margin-bottom: 15px; box-shadow: 0 4px 8px rgba(0,0,0,0.08); display: flex; gap: 15px; transition: opacity 0.3s ease; }
        .event-card.voo { border-color: #007bff; }
        .event-card.hotel { border-color: #28a745; }
        .event-card.trem { border-color: #dc3545; }
        .event-card.deslocamento { border-color: #ffc107; }
        .event-icon { font-size: 1.8em; opacity: 0.7; padding-top: 5px; }
        .event-details { flex-grow: 1; }
        .event-details h3 { margin: 0 0 5px 0; font-size: 1.1em; }
        .event-details p { margin: 4px 0; font-size: 0.95em; color: #555; display: flex; align-items: center; gap: 8px; }
        .event-details p .fa-solid { color: var(--secondary-color); }
        .event-actions { margin-top: 15px; display: flex; flex-wrap: wrap; gap: 10px; }
        .action-btn { background-color: var(--border-color); color: var(--text-color); border: none; padding: 8px 12px; border-radius: 5px; font-size: 0.8em; text-decoration: none; display: inline-flex; align-items: center; gap: 5px; transition: background-color 0.2s; cursor: pointer; }
        .complete-btn { background-color: #e7f5ec; color: var(--success-color); border: 1px solid var(--success-color); }
        .uncomplete-btn { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .event-card.completed { opacity: 0.6; text-decoration: line-through; }
        .completed-message { font-size: 0.95em; color: var(--success-color); font-weight: bold; }
        
        /* Estilos do Dashboard */
        .dashboard-section { background: var(--card-background); padding: 20px; border-radius: 8px; margin-bottom: 25px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .dashboard-section h2 { margin-top: 0; color: var(--primary-color); }
        #trip-map { height: 400px; border-radius: 8px; }
        .progress-bar-container { background-color: var(--border-color); border-radius: 5px; overflow: hidden; }
        #progress-bar { height: 20px; width: 0%; background-color: var(--success-color); transition: width 0.5s ease; }
        #progress-text { text-align: center; margin-top: 10px; font-weight: bold; }
        .poi-filters { margin: 15px 0; }
        #poi-results { max-height: 300px; overflow-y: auto; }
        .poi-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--border-color); }
        .poi-item:last-child { border-bottom: none; }
        
        /* Modal de Clima */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { background-color: white; padding: 25px; border-radius: 10px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>Viagem para Europa 2025</h1>
        </header>

        <nav class="tab-nav">
            <button class="tab-btn active" data-tab="roteiro">Roteiro</button>
            <button class="tab-btn" data-tab="dashboard">Dashboard</button>
        </nav>

        <div id="roteiro-view" class="tab-content active">
            <div id="countdown">Calculando o tempo restante...</div>
            <div class="filters-wrapper">
                <nav class="filters" id="day-filters"></nav>
            </div>
            <main id="itinerary-container"></main>
        </div>

        <div id="dashboard-view" class="tab-content">
            <section class="dashboard-section">
                <h2>Progresso da Viagem</h2>
                <div class="progress-bar-container">
                    <div id="progress-bar"></div>
                </div>
                <p id="progress-text">0% concluído</p>
                <p id="distance-text">Distância percorrida: 0 km</p>
            </section>

            <section class="dashboard-section">
                <h2>Perto de Mim</h2>
                <button class="action-btn" id="find-poi-btn" style="width: 100%; padding: 12px; font-size: 1em; background-color: var(--primary-color); color: white;">
                    <i class="fa-solid fa-location-crosshairs"></i> Procurar Perto de Mim
                </button>
                <div class="poi-filters" id="poi-filters" style="display:none;">
                    <!-- Filtros de POI gerados aqui -->
                </div>
                <div id="poi-results"></div>
            </section>

            <section class="dashboard-section">
                <h2>Mapa da Viagem (Locais Visitados)</h2>
                <div id="trip-map">A carregar mapa...</div>
            </section>
        </div>
    </div>

    <!-- Modal para exibir o clima -->
    <div class="modal-overlay" id="weather-modal">
        <div class="modal-content">
            <h3 id="weather-location">Clima</h3>
            <div id="weather-info">Carregando...</div>
            <p class="weather-type" id="weather-type-label"></p>
            <button class="action-btn modal-close-btn" id="weather-modal-close">Fechar</button>
        </div>
    </div>
    
    <!-- Leaflet JS para o Mapa -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
        // ===============================================
        // DADOS DO ROTEIRO
        // ===============================================
        const itineraryData = [
            { id: 1, date: '25/07/2025', time: '05:30', type: 'Saída', location: 'Hotel Pullman Guarulhos Aeroporto', city: 'Guarulhos', country: 'Brasil', activity: 'Saída hotel', transport: 'Transfer', distance_km: 5.4, travel_time: '0h10m', notes: null, link: null, fileLink: null },
            { id: 2, date: '25/07/2025', time: '05:40', type: 'Chegada', location: 'Aeroporto GRU', city: 'Guarulhos', country: 'Brasil', activity: 'Chegada aeroporto', transport: 'N/A', distance_km: null, travel_time: null, notes: 'Terminal 3', link: null, fileLink: null },
            { id: 3, date: '25/07/2025', time: '09:25', type: 'Saída', location: 'Aeroporto GRU', city: 'Guarulhos', country: 'Brasil', activity: 'Voo GRU/MAD', transport: 'Avião', distance_km: 8420, travel_time: '9h30m', notes: 'Air China', link: null, fileLink: null },
            { id: 4, date: '26/07/2025', time: '00:30', type: 'Chegada', location: 'Aeroporto MAD', city: 'Madrid', country: 'Espanha', activity: 'Chegada aeroporto', transport: 'N/A', distance_km: null, travel_time: null, notes: 'Terminal 4', link: null, fileLink: null },
            { id: 5, date: '26/07/2025', time: '01:15', type: 'Saída', location: 'Aeroporto MAD', city: 'Madrid', country: 'Espanha', activity: 'Saída aeroporto', transport: 'Táxi/Uber/Transfer', distance_km: 6.5, travel_time: '0h10m', notes: null, link: null, fileLink: null },
            { id: 6, date: '26/07/2025', time: '01:25', type: 'Chegada', location: 'Hotel Pullman Madrid Airport & Feria', city: 'Madrid', country: 'Espanha', activity: 'Chegada no hotel', transport: 'N/A', distance_km: null, travel_time: null, notes: null, link: null, fileLink: null },
            { id: 7, date: '26/07/2025', time: '14:30', type: 'Saída', location: 'Hotel Pullman Madrid Airport & Feria', city: 'Madrid', country: 'Espanha', activity: 'Saída hotel', transport: 'Táxi/Uber/Transfer', distance_km: 6.9, travel_time: '0h08m', notes: 'Terminal 2', link: null, fileLink: null },
            { id: 8, date: '26/07/2025', time: '14:40', type: 'Chegada', location: 'Aeroporto MAD', city: 'Madrid', country: 'Espanha', activity: 'Chegada aeroporto', transport: 'N/A', distance_km: null, travel_time: null, notes: null, link: null, fileLink: null },
            { id: 9, date: '26/07/2025', time: '16:30', type: 'Saída', location: 'Aeroporto MAD', city: 'Madrid', country: 'Espanha', activity: 'Voo MAD/ORY', transport: 'Avião', distance_km: 1028, travel_time: '1h30m', notes: 'Air Europa', link: null, fileLink: null },
            { id: 10, date: '26/07/2025', time: '18:00', type: 'Chegada', location: 'Aeroporto ORY', city: 'Paris', country: 'França', activity: 'Chegada aeroporto', transport: 'N/A', distance_km: null, travel_time: null, notes: 'Terminal 1', link: null, fileLink: null },
            { id: 11, date: '26/07/2025', time: '18:30', type: 'Saída', location: 'Aeroporto ORY', city: 'Paris', country: 'França', activity: 'Saída aeroporto', transport: 'Trem/Metrô', distance_km: 14, travel_time: '0h30m', notes: null, link: null, fileLink: null },
            { id: 12, date: '26/07/2025', time: '18:45', type: 'Chegada', location: 'Hotel Mercure Paris Place d\'Italie', city: 'Paris', country: 'França', activity: 'Chegada hotel', transport: 'N/A', distance_km: null, travel_time: null, notes: null, link: null, fileLink: null },
            { id: 13, date: '31/07/2025', time: '08:00', type: 'Saída', location: 'Hotel Mercure Paris Place d\'Italie', city: 'Paris', country: 'França', activity: 'Saída hotel', transport: 'Metrô', distance_km: 7.3, travel_time: '0h25m', notes: null, link: null, fileLink: null },
            { id: 14, date: '31/07/2025', time: '08:30', type: 'Chegada', location: 'Estação Gare du Nord', city: 'Paris', country: 'França', activity: 'Chegada estação trem', transport: 'N/A', distance_km: null, travel_time: null, notes: 'Trem 9321', link: null, fileLink: null },
            { id: 15, date: '31/07/2025', time: '09:22', type: 'Saída', location: 'Estação Gare du Nord', city: 'Paris', country: 'França', activity: 'Trem Paris/Amsterdam', transport: 'Trem', distance_km: 500, travel_time: '3h28m', notes: null, link: null, fileLink: null },
            { id: 16, date: '31/07/2025', time: '12:50', type: 'Chegada', location: 'Amsterdam Centraal', city: 'Amsterdam', country: 'Holanda', activity: 'Chegada estação trem', transport: 'N/A', distance_km: null, travel_time: null, notes: null, link: null, fileLink: null },
            { id: 17, date: '31/07/2025', time: '13:00', type: 'Saída', location: 'Amsterdam Centraal', city: 'Amsterdam', country: 'Holanda', activity: 'Saída estação trem', transport: 'Metrô', distance_km: 5.3, travel_time: '0h15m', notes: null, link: null, fileLink: null },
            { id: 18, date: '31/07/2025', time: '13:15', type: 'Chegada', location: 'Bunk Hotel Amsterdam', city: 'Amsterdam', country: 'Holanda', activity: 'Chegada hotel', transport: 'N/A', distance_km: null, travel_time: null, notes: null, link: null, fileLink: null },
            { id: 19, date: '01/08/2025', time: '18:30', type: 'Saída', location: 'Bunk Hotel Amsterdam', city: 'Amsterdam', country: 'Holanda', activity: 'Saída hotel', transport: 'Trem/Metrô', distance_km: 29.2, travel_time: '0h40m', notes: 'Terminal ?', link: null, fileLink: null },
            { id: 20, date: '01/08/2025', time: '19:10', type: 'Chegada', location: 'Aeroporto AMS', city: 'Amsterdam', country: 'Holanda', activity: 'Chegada aeroporto', transport: 'N/A', distance_km: null, travel_time: null, notes: null, link: null, fileLink: null },
            { id: 21, date: '01/08/2025', time: '21:30', type: 'Saída', location: 'Aeroporto AMS', city: 'Amsterdam', country: 'Holanda', activity: 'Voo AMS/ARN', transport: 'Avião', distance_km: 1441, travel_time: 'N/A', notes: 'Norwegian', link: null, fileLink: null },
            { id: 22, date: '01/08/2025', time: '23:50', type: 'Chegada', location: 'Aeroporto ARN', city: 'Estocolmo', country: 'Suécia', activity: 'Chegada aeroporto', transport: 'N/A', distance_km: null, travel_time: null, notes: 'Terminal 5', link: null, fileLink: null },
            { id: 23, date: '02/08/2025', time: '00:15', type: 'Saída', location: 'Aeroporto ARN', city: 'Estocolmo', country: 'Suécia', activity: 'Saída aeroporto', transport: 'Carona', distance_km: 109, travel_time: '1h15m', notes: null, link: null, fileLink: null },
            { id: 24, date: '02/08/2025', time: '01:30', type: 'Chegada', location: 'Casa Sabrina e Rafa', city: 'Mariefred', country: 'Suécia', activity: 'Chegada hotel', transport: 'N/A', distance_km: null, travel_time: null, notes: null, link: null, fileLink: null },
            { id: 25, date: '07/08/2025', time: '14:30', type: 'Saída', location: 'Casa Sabrina e Rafa', city: 'Mariefred', country: 'Suécia', activity: 'Saída hotel', transport: 'Carona', distance_km: 109, travel_time: '1h15m', notes: null, link: null, fileLink: null },
            { id: 26, date: '07/08/2025', time: '15:45', type: 'Chegada', location: 'Aeroporto ARN', city: 'Estocolmo', country: 'Suécia', activity: 'Chegada aeroporto', transport: 'N/A', distance_km: null, travel_time: null, notes: 'Terminal 5', link: null, fileLink: null },
            { id: 27, date: '07/08/2025', time: '17:50', type: 'Saída', location: 'Aeroporto ARN', city: 'Estocolmo', country: 'Suécia', activity: 'Voo ARN/HAM', transport: 'Avião', distance_km: 1150, travel_time: '1h20m', notes: 'EuroWings', link: null, fileLink: null },
            { id: 28, date: '07/08/2025', time: '19:20', type: 'Chegada', location: 'Aeroporto HAM', city: 'Hamburgo', country: 'Alemanha', activity: 'Chegada aeroporto', transport: 'N/A', distance_km: null, travel_time: null, notes: 'Terminal 1', link: null, fileLink: null },
            { id: 29, date: '07/08/2025', time: '19:50', type: 'Saída', location: 'Aeroporto HAM', city: 'Hamburgo', country: 'Alemanha', activity: 'Saída aeroporto', transport: 'Táxi/Uber/Metrô', distance_km: 11, travel_time: '0h40m', notes: null, link: null, fileLink: null },
            { id: 30, date: '07/08/2025', time: '20:30', type: 'Chegada', location: 'Sixt Reeperbahn', city: 'Hamburgo', country: 'Alemanha', activity: 'Chegada locadora', transport: 'N/A', distance_km: null, travel_time: null, notes: null, link: null, fileLink: null },
            { id: 31, date: '07/08/2025', time: '21:00', type: 'Saída', location: 'Sixt Reeperbahn', city: 'Hamburgo', country: 'Alemanha', activity: 'Saída locadora', transport: 'Carro', distance_km: 283, travel_time: '2h50m', notes: null, link: null, fileLink: null },
            { id: 32, date: '07/08/2025', time: '23:50', type: 'Chegada', location: 'AC Hotel Marriott Berlin Humboldthain Park', city: 'Berlim', country: 'Alemanha', activity: 'Chegada Hotel', transport: 'N/A', distance_km: null, travel_time: null, notes: null, link: null, fileLink: null },
            { id: 33, date: '09/08/2025', time: '10:00', type: 'Saída', location: 'AC Hotel Marriott Berlin Humboldthain Park', city: 'Berlim', country: 'Alemanha', activity: 'Saída hotel', transport: 'Carro', distance_km: 228, travel_time: '2h30m', notes: null, link: null, fileLink: null },
            { id: 34, date: '09/08/2025', time: '12:30', type: 'Chegada', location: 'Shell Recharge Jenaer Str. 52', city: 'Eisenberg', country: 'Alemanha', activity: 'Parada recarregar e almoço', transport: 'Carro', distance_km: null, travel_time: null, notes: 'Restaurante Bollywood - Eisenberg', link: null, fileLink: null },
            { id: 35, date: '09/08/2025', time: '13:30', type: 'Saída', location: 'Shell Recharge Jenaer Str. 52', city: 'Eisenberg', country: 'Alemanha', activity: 'Saída estação recarga', transport: 'Carro', distance_km: 368, travel_time: '3h40m', notes: null, link: null, fileLink: null },
            { id: 36, date: '09/08/2025', time: '17:10', type: 'Chegada', location: 'Motel One München-Messe', city: 'Munique', country: 'Alemanha', activity: 'Chegada Hotel', transport: 'N/A', distance_km: null, travel_time: null, notes: null, link: null, fileLink: null },
            { id: 37, date: '10/08/2025', time: '08:00', type: 'Saída', location: 'Motel One München-Messe', city: 'Munique', country: 'Alemanha', activity: 'Saída hotel', transport: 'Carro', distance_km: 13, travel_time: '0h15m', notes: null, link: null, fileLink: null },
            { id: 38, date: '10/08/2025', time: '08:15', type: 'Chegada', location: 'Serways Raststätte Vaterstetten Ost', city: 'Vaterstetten', country: 'Alemanha', activity: 'Parada recarregar e café', transport: 'Carro', distance_km: null, travel_time: null, notes: null, link: null, fileLink: null },
            { id: 39, date: '10/08/2025', time: '09:15', type: 'Saída', location: 'Serways Raststätte Vaterstetten Ost', city: 'Vaterstetten', country: 'Alemanha', activity: 'Saída estação recarga', transport: 'Carro', distance_km: 339, travel_time: '3h10m', notes: null, link: null, fileLink: null },
            { id: 40, date: '10/08/2025', time: '12:25', type: 'Chegada', location: 'Trento Ionity', city: 'Trento', country: 'Itália', activity: 'Parada recarga', transport: 'Carro', distance_km: null, travel_time: null, notes: null, link: null, fileLink: null },
            { id: 41, date: '10/08/2025', time: '13:00', type: 'Saída', location: 'Trento Ionity', city: 'Trento', country: 'Itália', activity: 'Saída recarga', transport: 'Carro', distance_km: 205, travel_time: '1h50m', notes: null, link: null, fileLink: null },
            { id: 42, date: '10/08/2025', time: '14:50', type: 'Chegada', location: 'Hotel Mercure Venezia Marghera', city: 'Veneza', country: 'Itália', activity: 'Chegada almoço', transport: 'Carro', distance_km: null, travel_time: null, notes: null, link: null, fileLink: null },
            { id: 43, date: '11/08/2025', time: '13:00', type: 'Saída', location: 'Hotel Mercure Venezia Marghera', city: 'Veneza', country: 'Itália', activity: 'Saída hotel', transport: 'Carro', distance_km: 5, travel_time: '0h30m', notes: null, link: null, fileLink: null },
            { id: 44, date: '11/08/2025', time: '13:30', type: 'Chegada', location: 'Monselice Ionity', city: 'Monselice', country: 'Itália', activity: 'Parada recarga', transport: 'Carro', distance_km: null, travel_time: null, notes: null, link: null, fileLink: null },
            { id: 45, date: '11/08/2025', time: '14:00', type: 'Saída', location: 'Monselice Ionity', city: 'Monselice', country: 'Itália', activity: 'Saída recarga', transport: 'Carro', distance_km: 134, travel_time: '1h25m', notes: null, link: null, fileLink: null },
            { id: 46, date: '11/08/2025', time: '15:25', type: 'Chegada', location: 'Hotel Maranello Palace', city: 'Maranello', country: 'Itália', activity: 'Chegada Hotel', transport: 'Carro', distance_km: null, travel_time: null, notes: null, link: null, fileLink: null },
            { id: 47, date: '13/08/2025', time: '08:00', type: 'Saída', location: 'Hotel Maranello Palace', city: 'Maranello', country: 'Itália', activity: 'Saída Hotel', transport: 'Carro', distance_km: 73, travel_time: '0h50m', notes: null, link: null, fileLink: null },
            { id: 48, date: '13/08/2025', time: '08:50', type: 'Chegada', location: 'Novotel Parma Centro', city: 'Parma', country: 'Itália', activity: 'Chegada Hotel', transport: 'Carro', distance_km: null, travel_time: null, notes: null, link: null, fileLink: null },
            { id: 49, date: '14/08/2025', time: '08:30', type: 'Saída', location: 'Novotel Parma Centro', city: 'Parma', country: 'Itália', activity: 'Saída Hotel', transport: 'Carro', distance_km: 276, travel_time: '3h00m', notes: null, link: null, fileLink: null },
            { id: 50, date: '14/08/2025', time: '11:30', type: 'Chegada', location: 'Mercure Gênova San Biago', city: 'Gênova', country: 'Itália', activity: 'Chegada Hotel', transport: 'Carro', distance_km: null, travel_time: null, notes: null, link: null, fileLink: null },
            { id: 51, date: '15/08/2025', time: '07:00', type: 'Saída', location: 'Mercure Gênova San Biago', city: 'Gênova', country: 'Itália', activity: 'Saída Hotel', transport: 'Carro', distance_km: 107, travel_time: '1h10m', notes: null, link: null, fileLink: null },
            { id: 52, date: '15/08/2025', time: '08:10', type: 'Chegada', location: 'A2A Via Don Mario Gandolfi 15, Trivolzio', city: 'Trivolzio', country: 'Itália', activity: 'Parada recarregar e café', transport: 'Carro', distance_km: null, travel_time: null, notes: null, link: null, fileLink: null },
            { id: 53, date: '15/08/2025', time: '08:50', type: 'Saída', location: 'A2A Via Don Mario Gandolfi 15, Trivolzio', city: 'Trivolzio', country: 'Itália', activity: 'Saída recarga', transport: 'Carro', distance_km: 307, travel_time: '3h30m', notes: null, link: null, fileLink: null },
            { id: 54, date: '15/08/2025', time: '12:20', type: 'Chegada', location: 'Estacionamento Zurich', city: 'Zurique', country: 'Suiça', activity: 'Chegada estacionamento e almoço', transport: 'Carro', distance_km: null, travel_time: null, notes: null, link: null, fileLink: null },
            { id: 55, date: '15/08/2025', time: '19:00', type: 'Saída', location: 'Estacionamento Zurich', city: 'Zurique', country: 'Suiça', activity: 'Saída estacionamento', transport: 'Carro', distance_km: 214, travel_time: '2h00m', notes: null, link: null, fileLink: null },
            { id: 56, date: '15/08/2025', time: '21:00', type: 'Chegada', location: 'Mercure Hotel Sttugart Airport Messe', city: 'Stuttgart', country: 'Alemanha', activity: 'Chegada Hotel', transport: 'Carro', distance_km: null, travel_time: null, notes: 'carregar em Enbw city Sttutgart', link: null, fileLink: null },
            { id: 57, date: '16/08/2025', time: '10:00', type: 'Saída', location: 'Mercure Hotel Sttugart Airport Messe', city: 'Stuttgart', country: 'Alemanha', activity: 'Saída Hotel', transport: 'Carro', distance_km: 208, travel_time: '1h50m', notes: null, link: null, fileLink: null },
            { id: 58, date: '16/08/2025', time: '11:50', type: 'Chegada', location: 'Estacionamento Frankfurt', city: 'Frankfurt', country: 'Alemanha', activity: 'Parada recarregar e almoço', transport: 'Carro', distance_km: null, travel_time: null, notes: null, link: null, fileLink: null },
            { id: 59, date: '16/08/2025', time: '13:50', type: 'Saída', location: 'Estacionamento Frankfurt', city: 'Frankfurt', country: 'Alemanha', activity: 'Saída estacionamento', transport: 'Carro', distance_km: 393, travel_time: '3h30m', notes: null, link: null, fileLink: null },
            { id: 60, date: '16/08/2025', time: '17:20', type: 'Chegada', location: 'Aral Pulse An Der Autobahn 1 Buchholz Aller', city: 'Buchholz', country: 'Alemanha', activity: 'Parada recarga', transport: 'Carro', distance_km: null, travel_time: null, notes: null, link: null, fileLink: null },
            { id: 61, date: '16/08/2025', time: '17:40', type: 'Saída', location: 'Aral Pulse An Der Autobahn 1 Buchholz Aller', city: 'Buchholz', country: 'Alemanha', activity: 'Saída recarga', transport: 'Carro', distance_km: 127, travel_time: '1h20m', notes: null, link: null, fileLink: null },
            { id: 62, date: '16/08/2025', time: '19:00', type: 'Chegada', location: 'Boutique Hotel Poppenbütteler Hof', city: 'Hamburgo', country: 'Alemanha', activity: 'Chegada Hotel', transport: 'Carro', distance_km: null, travel_time: null, notes: null, link: null, fileLink: null },
            { id: 63, date: '16/08/2025', time: '21:00', type: 'Saída', location: 'Boutique Hotel Poppenbütteler Hof', city: 'Hamburgo', country: 'Alemanha', activity: 'Saída Hotel', transport: 'Carro', distance_km: 16, travel_time: '0h30m', notes: null, link: null, fileLink: null },
            { id: 64, date: '16/08/2025', time: '21:30', type: 'Chegada', location: 'Sixt Reeperbahn', city: 'Hamburgo', country: 'Alemanha', activity: 'Devolução carro', transport: 'Carro', distance_km: null, travel_time: null, notes: null, link: null, fileLink: null },
            { id: 65, date: '16/08/2025', time: '22:00', type: 'Saída', location: 'Sixt Reeperbahn', city: 'Hamburgo', country: 'Alemanha', activity: 'Saída devolução', transport: 'Táxi/Uber/Transfer', distance_km: 16, travel_time: '0h30m', notes: null, link: null, fileLink: null },
            { id: 66, date: '16/08/2025', time: '22:30', type: 'Chegada', location: 'Boutique Hotel Poppenbütteler Hof', city: 'Hamburgo', country: 'Alemanha', activity: 'Retorno hotel', transport: 'N/A', distance_km: null, travel_time: null, notes: null, link: null, fileLink: null },
            { id: 67, date: '17/08/2025', time: '04:30', type: 'Saída', location: 'Boutique Hotel Poppenbütteler Hof', city: 'Hamburgo', country: 'Alemanha', activity: 'Saída Hotel', transport: 'Táxi/Uber/Transfer', distance_km: 7, travel_time: '0h10m', notes: 'terminal 2', link: null, fileLink: null },
            { id: 68, date: '17/08/2025', time: '04:40', type: 'Chegada', location: 'Aeroporto HAM', city: 'Hamburgo', country: 'Alemanha', activity: 'Chegada Aeroporto', transport: 'N/A', distance_km: null, travel_time: null, notes: null, link: null, fileLink: null },
            { id: 69, date: '17/08/2025', time: '06:50', type: 'Saída', location: 'Aeroporto HAM', city: 'Hamburgo', country: 'Alemanha', activity: 'Voo HAM/MAD', transport: 'Avião', distance_km: 2179, travel_time: '3h00m', notes: 'Iberia IB 0778', link: null, fileLink: null },
            { id: 70, date: '17/08/2025', time: '09:50', type: 'Chegada', location: 'Aeroporto MAD', city: 'Madrid', country: 'Espanha', activity: 'Chegada Aeroporto', transport: 'N/A', distance_km: null, travel_time: null, notes: 'terminal 4', link: null, fileLink: null },
            { id: 71, date: '17/08/2025', time: '10:30', type: 'Saída', location: 'Aeroporto MAD', city: 'Madrid', country: 'Espanha', activity: 'Saída aeroporto', transport: 'Táxi/Uber/Transfer', distance_km: 26, travel_time: '0h25m', notes: null, link: null, fileLink: null },
            { id: 72, date: '17/08/2025', time: '10:55', type: 'Chegada', location: 'Oriente Palace Apartments', city: 'Madrid', country: 'Espanha', activity: 'Chegada Airbnb', transport: 'N/A', distance_km: null, travel_time: null, notes: null, link: null, fileLink: null },
            { id: 73, date: '18/08/2025', time: '19:15', type: 'Saída', location: 'Oriente Palace Apartments', city: 'Madrid', country: 'Espanha', activity: 'Saída Airbnb', transport: 'Táxi/Uber/Transfer', distance_km: 26, travel_time: '0h25m', notes: 'terminal 1', link: null, fileLink: null },
            { id: 74, date: '18/08/2025', time: '19:40', type: 'Chegada', location: 'Aeroporto MAD', city: 'Madrid', country: 'Espanha', activity: 'Chegada Aeroporto', transport: 'N/A', distance_km: null, travel_time: null, notes: null, link: null, fileLink: null },
            { id: 75, date: '18/08/2025', time: '23:15', type: 'Saída', location: 'Aeroporto MAD', city: 'Madrid', country: 'Espanha', activity: 'Voo MAD/GRU', transport: 'Avião', distance_km: 8420, travel_time: '10h30m', notes: 'AirChina CA 897', link: null, fileLink: null },
            { id: 76, date: '19/08/2025', time: '05:00', type: 'Chegada', location: 'Aeroporto GRU', city: 'Guarulhos', country: 'Brasil', activity: 'Chegada Aeroporto', transport: 'N/A', distance_km: null, travel_time: null, notes: 'terminal 3', link: null, fileLink: null }
        ];

        let orderedDays = [];
        let tripMap = null; // Variável para o mapa Leaflet
        let visitedMarkers = L.layerGroup(); // Grupo de marcadores

        document.addEventListener('DOMContentLoaded', () => {
            // Garante que os dados estejam ordenados por data e hora
            itineraryData.sort((a, b) => {
                const dateA = parseBrazilianDate(a.date, a.time);
                const dateB = parseBrazilianDate(b.date, b.time);
                if (!dateA) return 1; if (!dateB) return -1;
                return dateA - dateB;
            });
            // Inicia a aplicação
            setupTabs();
            setupRoteiroView();
            setupDashboardView();
        });

        // ===============================================
        // SETUP INICIAL DAS ABAS E VISUALIZAÇÕES
        // ===============================================
        function setupTabs() {
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');

                    tabContents.forEach(content => content.classList.remove('active'));
                    document.getElementById(`${button.dataset.tab}-view`).classList.add('active');

                    // Inicializa o mapa apenas quando a aba do dashboard for visível pela primeira vez
                    if (button.dataset.tab === 'dashboard' && !tripMap) {
                        initTripMap();
                    }
                });
            });
        }

        function setupRoteiroView() {
            setupCountdown();
            setupFilters();
            renderItinerary(orderedDays.find(day => !isDayCompleted(day)) || 'all');
            setupRoteiroEventListeners();
        }

        function setupDashboardView() {
            updateTripProgress();
            document.getElementById('find-poi-btn').addEventListener('click', findPointsOfInterest);
        }


        // ===============================================
        // LÓGICA DO ROTEIRO
        // ===============================================
        function parseBrazilianDate(dateStr, timeStr) { /* ... (sem alterações) ... */ if (!dateStr || !timeStr) return null; const dateParts = dateStr.split('/'); if (dateParts.length !== 3) return null; const [day, month, year] = dateParts; const timeParts = timeStr.split(':'); if (timeParts.length !== 2) return null; const [hours, minutes] = timeParts; if (isNaN(day) || isNaN(month) || isNaN(year) || isNaN(hours) || isNaN(minutes)) return null; const date = new Date(year, month - 1, day, hours, minutes); if (isNaN(date.getTime())) return null; return date; }
        function isDayCompleted(dayDate) { /* ... (sem alterações) ... */ const completedEvents = JSON.parse(localStorage.getItem('completedEvents')) || {}; const eventsOnDay = itineraryData.filter(e => e.date === dayDate); if (eventsOnDay.length === 0) return false; return eventsOnDay.every(event => completedEvents[event.id]); }
        function findNextIncompleteDay(completedDay) { /* ... (sem alterações) ... */ const currentDayIndex = orderedDays.indexOf(completedDay); for (let i = currentDayIndex + 1; i < orderedDays.length; i++) { const nextDay = orderedDays[i]; if (!isDayCompleted(nextDay)) { return nextDay; } } return 'all'; }
        function switchActiveFilter(newFilter) { /* ... (sem alterações) ... */ document.querySelector('.filter-btn.active')?.classList.remove('active'); const newActiveButton = document.querySelector(`.filter-btn[data-filter="${newFilter}"]`); if(newActiveButton) { newActiveButton.classList.add('active'); newActiveButton.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' }); } }
        
        function toggleEventCompletion(eventId) {
            const completedEvents = JSON.parse(localStorage.getItem('completedEvents')) || {};
            const eventDetails = itineraryData.find(e => e.id == eventId);
            if (!eventDetails) return;
            const dayOfEvent = eventDetails.date;

            if (completedEvents[eventId]) {
                delete completedEvents[eventId];
            } else {
                const now = new Date();
                const completionTimestamp = now.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' }) + ' às ' + now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                completedEvents[eventId] = completionTimestamp;
            }
            localStorage.setItem('completedEvents', JSON.stringify(completedEvents));

            const currentFilter = document.querySelector('.filter-btn.active').dataset.filter;
            if (isDayCompleted(dayOfEvent) && currentFilter === dayOfEvent) {
                const nextDay = findNextIncompleteDay(dayOfEvent);
                switchActiveFilter(nextDay);
            }

            setupFilters(); 
            renderItinerary(document.querySelector('.filter-btn.active').dataset.filter);
            updateTripProgress(); // Atualiza o dashboard
            updateVisitedMarkers(); // Atualiza o mapa
        }

        function setupRoteiroEventListeners() {
            document.getElementById('itinerary-container').addEventListener('click', (e) => {
                if (e.target.closest('.toggle-complete-btn')) {
                    toggleEventCompletion(e.target.closest('.toggle-complete-btn').dataset.id);
                } else if (e.target.closest('.weather-btn')) {
                    checkWeather(itineraryData.find(evt => evt.id == e.target.closest('.weather-btn').dataset.id));
                }
            });
             document.getElementById('day-filters').addEventListener('click', (e) => {
                if (e.target.classList.contains('filter-btn')) {
                    switchActiveFilter(e.target.dataset.filter);
                    renderItinerary(e.target.dataset.filter);
                }
            });
            document.getElementById('weather-modal-close').addEventListener('click', () => {
                document.getElementById('weather-modal').classList.remove('visible');
            });
        }
        
        function setupFilters() { /* ... (sem alterações) ... */ const filtersContainer = document.getElementById('day-filters'); const currentActiveFilter = document.querySelector('.filter-btn.active')?.dataset.filter; orderedDays = [...new Set(itineraryData.map(item => item.date).filter(Boolean))]; const allDaysForFilters = ['all', ...orderedDays]; filtersContainer.innerHTML = allDaysForFilters.map((day, index) => { const isCompleted = day !== 'all' && isDayCompleted(day); const label = day === 'all' ? 'Todos' : `Dia ${index + 1} (${day.substring(0, 5)})`; return `<button class="filter-btn ${isCompleted ? 'completed' : ''}" data-filter="${day}">${label}</button>` }).join(''); const activeFilterToSet = currentActiveFilter || orderedDays.find(day => !isDayCompleted(day)) || 'all'; switchActiveFilter(activeFilterToSet); }
        function renderItinerary(filter = 'all') { /* ... (sem alterações) ... */ const container = document.getElementById('itinerary-container'); container.innerHTML = ''; const completedEvents = JSON.parse(localStorage.getItem('completedEvents')) || {}; const filteredData = filter === 'all' ? itineraryData : itineraryData.filter(item => item.date === filter); const groupedByDate = filteredData.reduce((acc, item) => { if (!item.date) return acc; const eventDate = parseBrazilianDate(item.date, '00:00'); if (!eventDate) return acc; const dateKey = eventDate.toLocaleDateString('pt-BR', { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' }); if (!acc[dateKey]) { acc[dateKey] = []; } acc[dateKey].push(item); return acc; }, {}); for (const date in groupedByDate) { const dayGroup = document.createElement('div'); dayGroup.className = 'day-group'; const dayHeader = document.createElement('h2'); dayHeader.className = 'day-header'; dayHeader.textContent = date; dayGroup.appendChild(dayHeader); groupedByDate[date].sort((a,b) => (a.time || "00:00").localeCompare(b.time || "00:00")); groupedByDate[date].forEach(item => { const isCompleted = !!completedEvents[item.id]; const completionTime = completedEvents[item.id]; dayGroup.appendChild(createEventCard(item, isCompleted, completionTime)); }); container.appendChild(dayGroup); } }
        function createEventCard(item, isCompleted, completionTime) { /* ... (sem alterações) ... */ const card = document.createElement('div'); const { icon, typeClass } = getEventIconAndClass(item); card.className = `event-card ${typeClass} ${isCompleted ? 'completed' : ''}`; const timeInfo = isCompleted ? `<p class="completed-message">✅ Evento concluído em: ${completionTime}</p>` : `<p class="event-time"><i class="fa-solid fa-clock"></i>Horário: ${item.time || 'N/A'}</p>`; const notesInfo = item.notes ? `<p><i class="fa-solid fa-circle-info"></i>Obs: ${item.notes}</p>` : ''; card.innerHTML = ` <div class="event-icon">${icon}</div> <div class="event-details"> <h3>${item.activity || 'Atividade não definida'}</h3> ${timeInfo} <p><i class="fa-solid fa-location-dot"></i>${item.location || ''}, ${item.city || ''}</p> ${notesInfo} <div class="event-actions"> ${generateToggleButton(item.id, isCompleted)} ${generateWeatherButton(item.id)} ${generateCalendarLink(item)} ${generateMapLink(item)} ${generateGenericLink(item.link)} ${generateFileLink(item.fileLink)} </div> </div>`; return card; }
        function generateToggleButton(id, isCompleted) { /* ... (sem alterações) ... */ const btnClass = isCompleted ? 'uncomplete-btn' : 'complete-btn'; const btnText = isCompleted ? '✖ Desfazer' : '✔ Concluir'; return `<button class="action-btn ${btnClass} toggle-complete-btn" data-id="${id}">${btnText}</button>`; }
        function generateGenericLink(link) { /* ... (sem alterações) ... */ if (!link || link === "N/A") return ''; return `<a href="${link}" target="_blank" class="action-btn"><i class="fa-solid fa-link"></i> Ver Link</a>`; }
        function generateFileLink(fileLink) { /* ... (sem alterações) ... */ if (!fileLink || fileLink === "N/A") return ''; return `<a href="${fileLink}" target="_blank" class="action-btn"><i class="fa-solid fa-file-arrow-down"></i> Abrir Arquivo</a>`; }
        function setupCountdown() { /* ... (sem alterações) ... */ if (itineraryData.length === 0) return; const countdownElement = document.getElementById('countdown'); const tripStartDate = parseBrazilianDate(itineraryData[0].date, itineraryData[0].time); if (!tripStartDate || isNaN(tripStartDate.getTime())) { countdownElement.innerHTML = "Data de início da viagem inválida."; return; } const interval = setInterval(() => { const distance = tripStartDate.getTime() - new Date().getTime(); if (distance < 0) { clearInterval(interval); countdownElement.innerHTML = "Boa viagem!"; return; } const days = Math.floor(distance / (1000 * 60 * 60 * 24)); const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)); const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60)); const seconds = Math.floor((distance % (1000 * 60)) / 1000); countdownElement.innerHTML = `Faltam: ${days}d ${hours}h ${minutes}m ${seconds}s`; }, 1000); }
        function getEventIconAndClass(item) { /* ... (sem alterações) ... */ const activity = (item.activity || '').toLowerCase(); const transport = (item.transport || '').toLowerCase(); if (activity.includes('voo')) return { icon: '<i class="fa-solid fa-plane-departure"></i>', typeClass: 'voo' }; if (activity.includes('hotel')) return { icon: '<i class="fa-solid fa-bed"></i>', typeClass: 'hotel' }; if (transport.includes('trem') || transport.includes('metrô')) return { icon: '<i class="fa-solid fa-train-subway"></i>', typeClass: 'trem' }; if (transport.includes('taxi') || transport.includes('uber') || transport.includes('carro') || transport.includes('transfer') || transport.includes('carona')) return { icon: '<i class="fa-solid fa-car"></i>', typeClass: 'deslocamento' }; if (item.type === 'Chegada') return { icon: '<i class="fa-solid fa-flag-checkered"></i>', typeClass: 'deslocamento' }; return { icon: '<i class="fa-solid fa-arrow-right-to-bracket"></i>', typeClass: 'deslocamento' }; }
        function generateMapLink(item) { /* ... (sem alterações) ... */ if (!item.location) return ''; const query = encodeURIComponent(`${item.location}, ${item.city}, ${item.country}`); return `<a href="https://www.google.com/maps/search/?api=1&query=${query}" target="_blank" class="action-btn"><i class="fa-solid fa-map-location-dot"></i> Ver no Mapa</a>`; }
        function generateCalendarLink(item) { /* ... (sem alterações) ... */ const startDate = parseBrazilianDate(item.date, item.time); if (!startDate || isNaN(startDate.getTime())) return ''; let travelTimeMinutes = 60; if (item.travel_time && item.travel_time !== 'N/A') { const travelTimeParts = item.travel_time.match(/(\d+)h(\d+)m/); if (travelTimeParts && travelTimeParts.length === 3) { travelTimeMinutes = parseInt(travelTimeParts[1]) * 60 + parseInt(travelTimeParts[2]); } } const endDate = new Date(startDate.getTime() + travelTimeMinutes * 60000); if (isNaN(endDate.getTime())) return ''; const formatTime = (date) => date.toISOString().replace(/-|:|\.\d+/g, ''); const startDateStr = formatTime(startDate); const endDateStr = formatTime(endDate); const url = `https://www.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(item.activity || '')}&dates=${startDateStr}/${endDateStr}&location=${encodeURIComponent((item.location || '') + ', ' + (item.city || ''))}&details=${encodeURIComponent('Observações: ' + (item.notes || 'Nenhuma'))}`; return `<a href="${url}" target="_blank" class="action-btn"><i class="fa-solid fa-calendar-plus"></i> Add ao Calendário</a>`; }
        function generateWeatherButton(id) { /* ... (sem alterações) ... */ return `<button class="action-btn weather-btn" data-id="${id}"><i class="fa-solid fa-cloud-sun"></i> Checar Clima</button>`; }
        async function checkWeather(event) { /* ... (sem alterações) ... */ const modal = document.getElementById('weather-modal'); const infoDiv = document.getElementById('weather-info'); const locationTitle = document.getElementById('weather-location'); const typeLabel = document.getElementById('weather-type-label'); locationTitle.textContent = `Clima em ${event.city}`; infoDiv.innerHTML = 'Carregando...'; typeLabel.textContent = ''; modal.classList.add('visible'); try { const geoResponse = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(event.city)}&count=1&language=pt&format=json`); const geoData = await geoResponse.json(); if (!geoData.results || geoData.results.length === 0) { throw new Error('Cidade não encontrada.'); } const { latitude, longitude } = geoData.results[0]; const eventDate = parseBrazilianDate(event.date, "00:00"); const today = new Date(); today.setHours(0,0,0,0); const diffDays = Math.ceil((eventDate - today) / (1000 * 60 * 60 * 24)); let weatherData; let isForecast = false; const eventDateFormatted = `${eventDate.getFullYear()}-${String(eventDate.getMonth() + 1).padStart(2, '0')}-${String(eventDate.getDate()).padStart(2, '0')}`; if (diffDays >= 0 && diffDays <= 16) { const forecastUrl = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=auto&start_date=${eventDateFormatted}&end_date=${eventDateFormatted}`; const response = await fetch(forecastUrl); weatherData = await response.json(); isForecast = true; } else { const lastYearDate = `${eventDate.getFullYear() - 1}-${String(eventDate.getMonth() + 1).padStart(2, '0')}-${String(eventDate.getDate()).padStart(2, '0')}`; const historicalUrl = `https://archive-api.open-meteo.com/v1/archive?latitude=${latitude}&longitude=${longitude}&start_date=${lastYearDate}&end_date=${lastYearDate}&daily=weathercode,temperature_2m_max,temperature_2m_min`; const response = await fetch(historicalUrl); weatherData = await response.json(); } if (!weatherData.daily || !weatherData.daily.weathercode) { throw new Error('Dados de clima não disponíveis para esta data/local.'); } const code = weatherData.daily.weathercode[0]; const maxTemp = weatherData.daily.temperature_2m_max[0]; const minTemp = weatherData.daily.temperature_2m_min[0]; const {icon, description} = getWeatherIconAndDescription(code); infoDiv.innerHTML = ` <i class="fa-solid ${icon}"></i> <p>${description}</p> <p><strong>Máx:</strong> ${maxTemp}°C / <strong>Mín:</strong> ${minTemp}°C</p> `; typeLabel.textContent = isForecast ? "Previsão do Tempo" : "Média Histórica (ano anterior)"; } catch (error) { console.error("Erro ao buscar clima:", error); infoDiv.innerHTML = 'Não foi possível obter os dados do clima.'; typeLabel.textContent = error.message; } }
        function getWeatherIconAndDescription(code) { /* ... (sem alterações) ... */ const codes = { 0: { icon: 'fa-sun', description: 'Céu limpo' }, 1: { icon: 'fa-cloud-sun', description: 'Principalmente limpo' }, 2: { icon: 'fa-cloud', description: 'Parcialmente nublado' }, 3: { icon: 'fa-smog', description: 'Nublado' }, 45: { icon: 'fa-smog', description: 'Nevoeiro' }, 48: { icon: 'fa-smog', description: 'Nevoeiro com geada' }, 51: { icon: 'fa-cloud-rain', description: 'Chuvisco leve' }, 53: { icon: 'fa-cloud-rain', description: 'Chuvisco moderado' }, 55: { icon: 'fa-cloud-showers-heavy', description: 'Chuvisco intenso' }, 61: { icon: 'fa-cloud-rain', description: 'Chuva leve' }, 63: { icon: 'fa-cloud-showers-heavy', description: 'Chuva moderada' }, 65: { icon: 'fa-cloud-bolt', description: 'Chuva forte' }, 71: { icon: 'fa-snowflake', description: 'Neve leve' }, 73: { icon: 'fa-snowflake', description: 'Neve moderada' }, 75: { icon: 'fa-snowflake', description: 'Neve intensa' }, 80: { icon: 'fa-cloud-showers-heavy', description: 'Pancadas de chuva leves' }, 81: { icon: 'fa-cloud-showers-heavy', description: 'Pancadas de chuva moderadas' }, 82: { icon: 'fa-cloud-bolt', description: 'Pancadas de chuva violentas' }, 95: { icon: 'fa-cloud-bolt', description: 'Trovoada' }, 96: { icon: 'fa-cloud-bolt', description: 'Trovoada com granizo leve' }, 99: { icon: 'fa-cloud-bolt', description: 'Trovoada com granizo forte' }, }; return codes[code] || { icon: 'fa-question-circle', description: 'Condição desconhecida' }; }

        // ===============================================
        // LÓGICA DO DASHBOARD
        // ===============================================
        
        function updateTripProgress() {
            const completedEvents = JSON.parse(localStorage.getItem('completedEvents')) || {};
            const completedCount = Object.keys(completedEvents).length;
            const totalCount = itineraryData.length;
            
            const percentage = totalCount > 0 ? (completedCount / totalCount) * 100 : 0;
            
            document.getElementById('progress-bar').style.width = `${percentage}%`;
            document.getElementById('progress-text').textContent = `${Math.round(percentage)}% concluído (${completedCount} de ${totalCount} eventos)`;

            let totalDistance = 0;
            for (const eventId in completedEvents) {
                const event = itineraryData.find(e => e.id == eventId);
                if (event && event.distance_km && !isNaN(parseFloat(event.distance_km))) {
                    totalDistance += parseFloat(event.distance_km);
                }
            }
            document.getElementById('distance-text').textContent = `Distância percorrida: ${totalDistance.toLocaleString('pt-BR')} km`;
        }

        function initTripMap() {
            if (tripMap) return;
            const mapDiv = document.getElementById('trip-map');
            mapDiv.innerHTML = ''; // Limpa a mensagem "A carregar..."
            tripMap = L.map('trip-map').setView([48.8566, 2.3522], 4); // Centraliza na Europa

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(tripMap);

            updateVisitedMarkers();
        }

        async function updateVisitedMarkers() {
            if (!tripMap) return;
            visitedMarkers.clearLayers(); // Limpa marcadores antigos
            const completedEvents = JSON.parse(localStorage.getItem('completedEvents')) || {};
            
            for (const eventId in completedEvents) {
                const event = itineraryData.find(e => e.id == eventId);
                if (event && event.city) {
                    try {
                        const geoResponse = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(event.city)}&count=1&language=en&format=json`);
                        const geoData = await geoResponse.json();
                        if (geoData.results && geoData.results.length > 0) {
                            const { latitude, longitude } = geoData.results[0];
                            const marker = L.marker([latitude, longitude]).addTo(visitedMarkers);
                            marker.bindPopup(`<b>${event.activity}</b><br>${event.location}, ${event.city}`);
                        }
                    } catch (error) {
                        console.error(`Erro ao geocodificar ${event.city}:`, error);
                    }
                }
            }
            visitedMarkers.addTo(tripMap);
        }

        async function findPointsOfInterest() {
            const resultsDiv = document.getElementById('poi-results');
            const findBtn = document.getElementById('find-poi-btn');
            const filtersDiv = document.getElementById('poi-filters');
            
            findBtn.disabled = true;
            resultsDiv.innerHTML = '<p>A obter a sua localização...</p>';

            if (!navigator.geolocation) {
                resultsDiv.innerHTML = '<p style="color:red;">Geolocalização não é suportada pelo seu navegador.</p>';
                findBtn.disabled = false;
                return;
            }

            navigator.geolocation.getCurrentPosition(async (position) => {
                const { latitude, longitude } = position.coords;
                resultsDiv.innerHTML = '<p>A procurar locais próximos...</p>';
                
                const poiCategories = {
                    Restaurantes: '[amenity=restaurant]',
                    'Pontos Turísticos': '[tourism=attraction]',
                    Passeios: '[tourism=artwork],[tourism=gallery],[tourism=museum]',
                    'Banheiros Públicos': '[amenity=toilets]',
                    Estacionamentos: '[amenity=parking]',
                    'Recarga EV': '[amenity=charging_station]'
                };
                
                filtersDiv.style.display = 'block';
                filtersDiv.innerHTML = Object.keys(poiCategories).map(cat => 
                    `<button class="action-btn poi-filter-btn" data-query="${poiCategories[cat]}">${cat}</button>`
                ).join('');

                document.querySelectorAll('.poi-filter-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        document.querySelectorAll('.poi-filter-btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        const queryPart = e.target.dataset.query;
                        fetchAndDisplayPOI(latitude, longitude, queryPart);
                    });
                });
                
                // Clica no primeiro filtro por defeito
                document.querySelector('.poi-filter-btn').click();

            }, (error) => {
                resultsDiv.innerHTML = `<p style="color:red;">Não foi possível obter a sua localização. Erro: ${error.message}</p>`;
            });
            
            findBtn.disabled = false;
        }
        
        async function fetchAndDisplayPOI(lat, lon, queryPart) {
            const resultsDiv = document.getElementById('poi-results');
            resultsDiv.innerHTML = `<p>A procurar por ${queryPart.replace(/[\[\]_]/g, ' ')}...</p>`;
            const radius = 2000; // 2km
            const overpassQuery = `
                [out:json];
                (
                  node${queryPart}(around:${radius},${lat},${lon});
                  way${queryPart}(around:${radius},${lat},${lon});
                  relation${queryPart}(around:${radius},${lat},${lon});
                );
                out center;`;
            
            try {
                const response = await fetch('https://overpass-api.de/api/interpreter', {
                    method: 'POST',
                    body: overpassQuery
                });
                const data = await response.json();

                if (data.elements.length === 0) {
                    resultsDiv.innerHTML = '<p>Nenhum resultado encontrado nesta categoria.</p>';
                    return;
                }
                
                resultsDiv.innerHTML = '';
                data.elements.forEach(el => {
                    if (el.tags && el.tags.name) {
                        const lat = el.lat || el.center.lat;
                        const lon = el.lon || el.center.lon;
                        const poiItem = document.createElement('div');
                        poiItem.className = 'poi-item';
                        poiItem.innerHTML = `
                            <span>${el.tags.name}</span>
                            <a href="https://www.google.com/maps?q=${lat},${lon}" target="_blank" class="action-btn" style="font-size: 0.7em;">Ver Mapa</a>
                        `;
                        resultsDiv.appendChild(poiItem);
                    }
                });

            } catch(error) {
                console.error("Erro na API Overpass:", error);
                resultsDiv.innerHTML = '<p style="color:red;">Ocorreu um erro ao procurar locais.</p>';
            }
        }
    </script>

</body>
</html>
